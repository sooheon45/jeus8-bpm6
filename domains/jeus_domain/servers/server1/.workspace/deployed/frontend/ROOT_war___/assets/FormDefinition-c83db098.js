import{M as E,F}from"./FormDesignSavePanel-9b7c3ce1.js";import{_,s as V,r as f,o as m,e as p,w as T,a as w,c as h,b as g,bk as b,h as v,A as k,f as I,bg as N,bh as D}from"./index-7b37f28a.js";import{F as S}from"./FormDesignGenerator-cf42b57e.js";import{C as O}from"./Chat-127d4b0d.js";import{_ as P}from"./DynamicForm-9e8c830e.js";import{_ as K}from"./FormDefinitionModule-1faf025f.js";import"./VSheet-beabeb52.js";import"./chat-icon-2658168f.js";import"./VDatePicker-b7697b5c.js";import"./customizer-3521e2ce.js";const q={mixins:[V,K],props:{type:{type:String,default:"edit"},formId:{type:String,default:""},modelValue:{type:String,default:""}},components:{Chat:O,Mashup:E,ChatGenerator:S,FormDesignSavePanel:F,DynamicForm:P},data:()=>({chatInfo:{title:"",text:"uiDefinition.uiDefinitionExplanation"},kEditorInput:"",mashupKey:0,kEditorContent:"",prevFormOutput:"",prevMessageFormat:"",formHTML:"",isShowMashup:!1,previewHTML:"",previewFormValues:{},isShowPreview:!1,dev:{isDevMode:window.localStorage.getItem("isDevMode")==="true",previewFormValues:""},isAIUpdated:!1,isRoutedWithUnsaved:!1}),async created(){this.modelValue!=""&&(this.kEditorInput=this.dynamicFormHTMLToKeditorContentHTML(this.modelValue)),this.generator=new S(this,{isStream:!0,preferredLanguage:"Korean"}),await this.init()},computed:{isMobile(){return window.innerWidth<=1080}},watch:{type(e,s){e==="edit"?this.applyNewSrcToMashup(this.modelValue):this.applyToPreviewTab()},previewHTML:{handler(e){this.EventBus.emit("updatePreviewHTML",e)},immediate:!0}},methods:{getFormHTML(){if(this.$refs.mashup){const e=this.$refs.mashup.getKEditorContentHtml();return this.keditorContentHTMLToDynamicFormHTML(e)}else return this.formHTML},changedKEditorContent(e){this.formHTML=this.keditorContentHTMLToDynamicFormHTML(e.html),this.$emit("update:modelValue",this.formHTML)},updateKEditorContentBeforeSave(e){},dynamicFormHTMLToKeditorContentHTML(e){const s=new DOMParser().parseFromString(e,"text/html");return s.querySelectorAll("row-layout").forEach(o=>{const d=o.getAttribute("is_multidata_mode");if(!d||d==="false"){const a=document.createElement("div");a.setAttribute("name",o.getAttribute("name")??""),a.setAttribute("alias",o.getAttribute("alias")??""),a.setAttribute("is_multidata_mode",o.getAttribute("is_multidata_mode")??"false"),a.setAttribute("class","row"),Array.from(o.firstChild.children).forEach(l=>{a.appendChild(l)}),$(a).children('[class^="col-sm-"]').children("[v-model]").each(function(){var l=$(this)[0];l.removeAttribute("v-model")}),$(a).children('[class^="col-sm-"]').children("*").each(function(){var l=$(this)[0];Array.from(l.attributes).forEach(t=>{t.name.startsWith("v-on:")&&l.removeAttribute(t.name)})}),o.parentNode.replaceChild(a,o)}else{const a=document.createElement("div");a.setAttribute("name",o.getAttribute("name")??""),a.setAttribute("alias",o.getAttribute("alias")??""),a.setAttribute("is_multidata_mode",o.getAttribute("is_multidata_mode")??"false"),a.setAttribute("class","row"),$(o).children("div").children("div.row").children('[class^="col-sm-"]').each(function(){var l=$(this)[0];a.appendChild(l)}),$(a).children('[class^="col-sm-"]').children("[v-model]").each(function(){var l=$(this)[0];l.removeAttribute("v-model")}),$(a).children('[class^="col-sm-"]').children("*").each(function(){var l=$(this)[0];Array.from(l.attributes).forEach(t=>{t.name.startsWith("v-on:")&&l.removeAttribute(t.name)})}),o.parentNode.replaceChild(a,o)}}),s.body.innerHTML.replace(/&quot;/g,"'").replace("<br>",`
`)},async saveFormDefinition(){const e=this.keditorContentHTMLToDynamicFormHTML(this.modelValue);if(this.formId!==""&&this.formId!==null){const s={type:"form"};await this.backend.putRawDefinition(e,this.formId,s)}},onClickPreviewSubmitButton(){const e=this.$refs.dynamicForm.validate();e&&e.length>0&&alert(e),this.dev.isDevMode?this.dev.previewFormValues=JSON.stringify(this.previewFormValues):alert(JSON.stringify(this.previewFormValues))},onClickPreviewApplyButton(){this.previewFormValues=JSON.parse(this.dev.previewFormValues)},async loadData(e){this.isShowMashup=!1,this.formHTML=await this.backend.getRawDefinition(this.formId,{type:"form"});let s="";this.modelValue?s=this.dynamicFormHTMLToKeditorContentHTML(this.modelValue):s=this.dynamicFormHTMLToKeditorContentHTML(this.formHTML);const i=this.loadHTMLToKEditorContent(s);this.applyNewSrcToMashup(i),this.isShowMashup=!0,this.applyToPreviewTab()},beforeSendMessage(e){this.prevFormOutput=this.$refs.mashup.getKEditorContentHtml(),e.mentionedUsers=null,this.generator.sendMessageWithPrevFormOutput(e)},async afterModelCreated(e){this.processResponse(e)},afterGenerationFinished(e){this.processResponse(e)},processResponse(e){try{let s=this.messages[this.messages.length-1];if(s.jsonContent=this.extractLastJSON(e),s.content=s.content.replace(s.jsonContent,""),s.content.length==0&&(s.content=" "),s.jsonContent){if(s.jsonContent.htmlOutput)this.$emit("update:modelValue",s.jsonContent.htmlOutput),this.applyNewSrcToMashup(this.loadHTMLToKEditorContent(s.jsonContent.htmlOutput)),this.previewHTML=this.keditorContentHTMLToDynamicFormHTML(s.jsonContent.htmlOutput);else if(s.jsonContent.modifications){const i=this.getModifiedPrevFormOutput(s.jsonContent.modifications);this.applyNewSrcToMashup(this.loadHTMLToKEditorContent(i)),this.previewHTML=this.keditorContentHTMLToDynamicFormHTML(i)}else console.error("알 수 없는 JSON 결과: ",JSON.stringify(s.jsonContent));this.isAIUpdated=!0}}catch(s){console.log(s)}},afterModelStopped(e){console.log(e)},loadHTMLToKEditorContent(e){if(!e)return"";const s=()=>{const t=()=>Math.floor((1+Math.random())*65536).toString(16).substring(1);return t()+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},i=new DOMParser().parseFromString(e,"text/html");i.querySelectorAll("div.row").forEach(t=>{let c=0;if($(t).children('[class^="col-sm-"]').each(function(){var r=$(this)[0];const n=r.className.match(/col-sm-(\d+)/);if(n){const u=parseInt(n[1],10);c+=u}}),c!==12){const r=document.createElement("div");r.setAttribute("class","col-sm-12"),$(t).children('[class^="col-sm-"]').each(function(){var n=$(this)[0];Array.from(n.children).forEach(u=>{r.appendChild(u)})}),t.innerHTML="",t.appendChild(r)}});let o=!1;if(i.querySelectorAll("div.row").forEach(t=>{t.parentElement.tagName.toLowerCase()!=="section"&&(o=!0)}),i.querySelectorAll("section").forEach(t=>{t.children.length!==1&&(o=!0)}),o){const t=r=>{const n=r.parentElement;for(;r.firstChild;)n.insertBefore(r.firstChild,r);n.removeChild(r)};(r=>{i.querySelectorAll(r).forEach(n=>{t(n)})})("section"),i.querySelectorAll("div.row").forEach(r=>{const n=document.createElement("section");r.parentElement.insertBefore(n,r),n.appendChild(r)})}if(i.querySelectorAll('[class^="col-sm-"]').forEach(t=>{t.setAttribute("data-type","container-content")}),Array.from(i.querySelectorAll("*")).filter(t=>t.tagName.toLowerCase().endsWith("-field")).forEach(t=>{if(["name"].forEach(r=>{if(t.hasAttribute(r)){const n=t.getAttribute(r).match(/[가-힣a-zA-Z0-9_\-. ]/g),u=n?n.join(""):r;t.setAttribute(r,u)}}),t.hasAttribute("items")){if(t.getAttribute("items").length==0)t.setAttribute("items","[]");else if(t.getAttribute("items")!=="[]")try{let r=JSON.parse(t.getAttribute("items").replace(/'/g,'"').replace(/[ ]*,[ ]*\.\.\.[ ]*,[ ]*/,",")),n=[];r.forEach(u=>{Object.keys(u).forEach(y=>{const A=u[y],M=y.match(/[가-힣a-zA-Z0-9_\-. ]/g),C=A.match(/[가-힣a-zA-Z0-9_\-. ]/g),L=M?M.join(""):"",H=C?C.join(""):"";n.push({[L]:H})})}),t.setAttribute("items",JSON.stringify(n))}catch(r){console.log(r),t.setAttribute("items","[]")}}const c=document.createElement("div");if(c.setAttribute("id",`vuemount_${s()}`),this.generator.avaliableComponentTagNames.includes(t.tagName.toLowerCase()))t.parentNode.insertBefore(c,t),c.appendChild(t);else if(t.hasAttribute("items")){const r=document.createElement("select-field");r.setAttribute("name",t.getAttribute("name")??"name"),r.setAttribute("alias",t.getAttribute("alias")??"alias"),r.setAttribute("items",t.getAttribute("items")??"[]"),t.parentNode.insertBefore(c,t),c.appendChild(r),t.parentNode.removeChild(t)}else if(t.hasAttribute("name")||t.hasAttribute("alias")){const r=document.createElement("text-field");r.setAttribute("name",t.getAttribute("name")??"name"),r.setAttribute("alias",t.getAttribute("alias")??"alias"),t.parentNode.insertBefore(c,t),c.appendChild(r),t.parentNode.removeChild(t)}else t.parentNode.removeChild(t)}),i.body.querySelectorAll("section").length==0){const t=Array.from(i.body.querySelectorAll(".row"));i.body.innerHTML=t.map(c=>{const r=document.createElement("section");return r.innerHTML=c.outerHTML,r.outerHTML}).join("").replace(/&quot;/g,"'")}return Array.from(i.body.querySelectorAll("section")).forEach(t=>{t.setAttribute("class","keditor-container")}),Array.from(i.body.children).map(t=>t.outerHTML).join("").replace(/&quot;/g,"'").replace("<br>",`
`)},applyNewSrcToMashup(e){this.kEditorInput=e,this.mashupKey+=1},getModifiedPrevFormOutput(e){const s=new DOMParser().parseFromString(this.prevFormOutput,"text/html");e.forEach(o=>{if(o.action==="addAsChild"){const d=s.querySelector(o.targetCSSSelector),a=new DOMParser().parseFromString(o.tagValue,"text/html");d.appendChild(a.body.firstChild)}else if(o.action==="addAfter"){const d=s.querySelector(o.targetCSSSelector),a=new DOMParser().parseFromString(o.tagValue,"text/html");d.parentNode.insertBefore(a.body.firstChild,d.nextSibling)}else if(o.action=="replace"){const d=s.querySelector(o.targetCSSSelector),a=new DOMParser().parseFromString(o.tagValue,"text/html");d.parentNode.replaceChild(a.body.firstChild,d)}else if(o.action==="delete"){const d=s.querySelector(o.targetCSSSelector);d.parentNode.removeChild(d)}});const i=s.body.outerHTML.replace(/&quot;/g,"'").replace("<br>",`
`);return console.log("### 수정된 이전 폼 출력 ###"),console.log(i),i},applyToPreviewTab(){var e=this;e.isShowPreview=!1,e.$try({context:e,action:async()=>{e.modelValue?e.previewHTML=e.keditorContentHTMLToDynamicFormHTML(e.modelValue):e.previewHTML=e.keditorContentHTMLToDynamicFormHTML(e.formHTML),console.log("### 프리뷰 HTML ###"),console.log(e.previewHTML)},onFail:()=>{e.previewHTML=""}}),e.previewFormValues={},e.$nextTick(()=>{e.isShowPreview=!0,e.dev.previewFormValues=JSON.stringify(e.previewFormValues)})}},async beforeRouteLeave(e,s,i){if(!this.$refs.mashup)return i();this.isAIUpdated||this.$refs.mashup.getKEditorContentHtml()!=this.kEditorContent?window.confirm(this.$t("changePath"))?i():i(!1):i()}},j=e=>(N("data-v-b2fa1ab9"),e=e(),D(),e),B={key:0,class:"w-100 d-flex justify-center"},R={key:0,class:"overflow-y-auto"},J={key:1,class:"align-self-center"},U={key:1,class:"w-100 mt-5"},x={key:1,class:"align-self-center"},W={key:2,class:"ml-auto",style:{"max-width":"250px"}},z=j(()=>w("div",null,null,-1));function G(e,s,i,o,d,a){const l=f("mashup"),t=f("DynamicForm"),c=f("Chat");return m(),p(I,{flat:""},{default:T(()=>[w("div",{class:k({"d-flex":!a.isMobile})},[i.type==="edit"?(m(),h("div",B,[e.isShowMashup?(m(),h("div",R,[(m(),p(l,{ref:"mashup",modelValue:e.kEditorInput,"onUpdate:modelValue":[s[0]||(s[0]=r=>e.kEditorInput=r),s[1]||(s[1]=r=>i.modelValue=r)],key:e.mashupKey,onOnInitKEditorContent:a.updateKEditorContentBeforeSave,onOnChangeKEditorContent:a.changedKEditorContent},null,8,["modelValue","onOnInitKEditorContent","onOnChangeKEditorContent"]))])):(m(),h("div",J,[g(b,{color:"primary",indeterminate:""})]))])):v("",!0),i.type==="preview"?(m(),h("div",U,[e.isShowPreview?(m(),p(t,{key:0,ref:"dynamicForm",formHTML:e.previewHTML,modelValue:e.previewFormValues,"onUpdate:modelValue":s[2]||(s[2]=r=>e.previewFormValues=r)},null,8,["formHTML","modelValue"])):(m(),h("div",x,[g(b,{color:"primary",indeterminate:""})]))])):v("",!0),!a.isMobile&&i.type!="preview"?(m(),h("div",W,[g(c,{chatInfo:e.chatInfo,messages:e.messages,userInfo:e.userInfo,type:"form",onSendMessage:a.beforeSendMessage,onSendEditedMessage:e.sendEditedMessage,onStopMessage:e.stopMessage},{"custom-title":T(()=>[z]),_:1},8,["chatInfo","messages","userInfo","onSendMessage","onSendEditedMessage","onStopMessage"])])):v("",!0)],2)]),_:1})}const ae=_(q,[["render",G],["__scopeId","data-v-b2fa1ab9"]]);export{ae as default};
